{
  "name": "QBY-Deploy-Updates",
  "type": "Microsoft.Authorization/policyDefinitions",
  "properties": {
    "displayName": "Configure update management for virtual machines with a given tag using Azure Update Manager",
    "policyType": "Custom",
    "mode": "Indexed",
    "description": "Create Maintenance configurations with dynamic scopes to enable update management when a new virtual machine with the tag 'Severity Group Monthly' is created.",
    "metadata": {
      "version": "1.0.0",
      "category": "Azure Update Manager"
    },
    "parameters": {
      "severityGroupName": {
        "type": "string",
        "metadata": {
          "description": "Name of the severity group/ maintenance configuration."
        }
      },
      "managementSubscriptionId": {
        "type": "string",
        "metadata": {
          "description": "Subscription ID of the management subscription."
        }
      },
      "managementResourceGroup": {
        "type": "string",
        "metadata": {
          "description": "Name of the management resource group. The maintenance configuration will be deloyed there."
        }
      },
      "location": {
        "type": "string",
        "metadata": {
          "description": "Location of the maintenance resources."
        }
      },
      "updateClassification": {
        "type": "array",
        "metadata": {
          "description": "Classification category of patches to be patched."
        }
      },
      "rebootSetting": {
        "allowedValues": [ "Always", "IfRequired", "Never" ],
        "type": "String",
        "metadata": {
          "description": "Reboot preference of the maintenance configuration."
        }
      },
      "duration": {
        "defaultValue": "03:55",
        "type": "String",
        "metadata": {
          "description": "Duration of the maintance window in format hh:mm. Maximum value is 03:55."
        }
      },
      "recurEvery": {
        "type": "String",
        "metadata": {
          "description": "Rate at which a Maintenance window is expected to recur. The rate can be expressed as daily, weekly, or monthly schedules. Format example: Month Last Sunday."
        }
      },
      "startDateTime": {
        "type": "String",
        "metadata": {
          "description": "StartDateTime in Format YYYY-MM-DD hh:mm. The StartDateTime can be a maximum of 24 hours back."
        }
      },
      "timeZone": {
        "defaultValue": "W. Europe Standard Time",
        "type": "String"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
          },
          {
            "field": "tags['Severity Group Monthly']",
            "exists": true
          },
          {
            "field": "tags['Severity Group Monthly']",
            "exists": true
          }
        ]
      },
      "then": {
        "effect": "DeployIfNotExists",
        "details": {
          "type": "Microsoft.Maintenance/maintenanceConfigurations",
          "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
          ],
          "deployment": {
             "mode": "Incremental",

        }
      }


      {
        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
        "contentVersion": "1.0.0.0",

        "variables": {
          "tagFilter": {
            "Severity Group Monthly": "[parameters('severityGroupName')]",
            "Update allowed": "yes"
          }
        },
        "resources": [
          {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "megadeployment",
            "subscriptionId": "[parameters('managementSubscriptionId')]",
            "resourceGroup": "[parameters('managementResourceGroup')]",
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {},
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Maintenance/maintenanceConfigurations",
                    "apiVersion": "2023-04-01",
                    "name": "[parameters('severityGroupName')]",
                    "location": "[parameters('location')]",
                    "properties": {
                      "extensionProperties": {
                        "InGuestPatchMode": "User"
                      },
                      "installPatches": {
                        "rebootSetting": "[parameters('rebootSetting')]",
                        "windowsParameters": {
                          "classificationsToInclude": "[parameters('updateClassification')]",
                          "excludeKbsRequiringReboot": "",
                          "kbNumbersToExclude": [],
                          "kbNumbersToInclude": []
                        }
                      },
                      "maintenanceScope": "InGuestPatch",
                      "maintenanceWindow": {
                        "duration": "[parameters('duration')]",
                        "recurEvery": "[parameters('recurEvery')]",
                        "startDateTime": "[parameters('startDateTime')]",
                        "timeZone": "[parameters('timeZone')]"
                      }
                    }
                  }
                ]
              }
            }
          },
          {
            "type": "Microsoft.Maintenance/maintenanceConfigurations",
            "apiVersion": "2023-04-01",
            "name": "[parameters('severityGroupName')]",
            "location": "[parameters('location')]",
            "dependsOn": [
              "Microsoft.Resources/deployments/megadeployment"
            ],
            "properties": {
              "extensionProperties": {
                "InGuestPatchMode": "User"
              },
              "installPatches": {
                "rebootSetting": "[parameters('rebootSetting')]",
                "windowsParameters": {
                  "classificationsToInclude": "[parameters('updateClassification')]",
                  "excludeKbsRequiringReboot": "",
                  "kbNumbersToExclude": [],
                  "kbNumbersToInclude": []
                }
              },
              "maintenanceScope": "InGuestPatch",
              "maintenanceWindow": {
                "duration": "[parameters('duration')]",
                "recurEvery": "[parameters('recurEvery')]",
                "startDateTime": "[parameters('startDateTime')]",
                "timeZone": "[parameters('timeZone')]"
              }
            }
          },
          {
            "type": "Microsoft.Maintenance/configurationAssignments",
            "apiVersion": "2023-04-01",
            "name": "[parameters('severityGroupName')]",
            "location": "[parameters('location')]",
            "properties": {
              "filter": {
                "tagSettings": {
                  "filterOperator": "All",
                  "tags": "[variables('tagFilter')]"
                }
              },
              "maintenanceConfigurationId": "[resourceId(subscription().subscriptionId, parameters('managementResourceGroup'), 'microsoft.maintenance/maintenanceconfigurations', parameters('severityGroupName'))]",
              "resourceId": "string"
            }
          },
          
        ]
      }
