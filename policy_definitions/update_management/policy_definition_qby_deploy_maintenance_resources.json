{
  "name": "QBY-Deploy-Updates",
  "type": "Microsoft.Authorization/policyDefinitions",
  "properties": {
    "displayName": "Configure update management for virtual machines with a given tag using Azure Update Manager",
    "policyType": "Custom",
    "mode": "Indexed",
    "description": "Create Maintenance configurations with dynamic scopes to enable update management when a new virtual machine with the tag 'Severity Group Monthly' is created.",
    "metadata": {
      "version": "1.0.0",
      "category": "Azure Update Manager"
    },
    "parameters": {
      "managementSubscriptionId": {
        "type": "String",
        "metadata": {
          "description": "Subscription ID of the management subscription."
        }
      },
      "managementResourceGroup": {
        "type": "String",
        "metadata": {
          "description": "Name of the management resource group. The maintenance configuration will be deloyed there."
        }
      },
      "location": {
        "type": "String",
        "metadata": {
          "description": "Location of the maintenance resources.",
          "strongType": "location"
        }
      },
      "duration": {
        "type": "String",
        "metadata": {
          "description": "Duration of the maintance window in format hh:mm. Maximum value is 03:55."
        },
        "defaultValue": "03:55"
      },
      "timeZone": {
        "type": "String",
        "metadata": {},
        "defaultValue": "W. Europe Standard Time"
      },
      "osTypes": {
        "type": "array",
        "defaultValue": [
          "Windows"
        ],
        "metadata": {
          "description": "OS Types that get filtered for in the cinfiguration assignment."
        }
      },
      "resourceTypes": {
        "type": "array",
        "defaultValue": [
          "microsoft.compute/virtualmachines"
        ],
        "metadata": {
          "description": "ResourceTypes that get filtered for in the cinfiguration assignment."
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "in": "[parameters('resourceTypes')]"
          },
          {
            "field": "tags['Severity Group Monthly']",
            "exists": true
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.HybridCompute/machines/osName",
                "in": "[parameters('osTypes')]"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
                "in": "[parameters('osTypes')]"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "DeployIfNotExists",
        "details": {
          "type": "Microsoft.Maintenance/configurationAssignments",
          "ExistenceScope": "Subscription",
          "existenceCondition": {
            "allOf": [
              {
                "field": "name",
                "equals": "[field(concat('tags[Severity Group Monthly]'))]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
          ],
          "DeploymentScope": "Subscription",
          "deployment": {
            "location": "westeurope",
            "properties": {
              "mode": "Incremental",
              "parameters": {
                "severityGroupName": {
                  "value": "[field(concat('tags[Severity Group Monthly]'))]"
                },
                "managementSubscriptionId": {
                  "value": "[parameters('managementSubscriptionId')]"
                },
                "managementResourceGroup": {
                  "value": "[parameters('managementResourceGroup')]"
                },
                "location": {
                  "value": "[parameters('location')]"
                },
                "duration": {
                  "value": "[parameters('duration')]"
                },
                "timeZone": {
                  "value": "[parameters('timeZone')]"
                },
                "osTypes": {
                  "value": "[parameters('osTypes')]"
                },
                "resourceTypes": {
                  "value": "[parameters('resourceTypes')]"
                }
              },
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "severityGroupName": {
                    "type": "string",
                    "metadata": {
                      "description": "Name of the severity group/ maintenance configuration."
                    }
                  },
                  "managementSubscriptionId": {
                    "type": "string",
                    "metadata": {
                      "description": "Subscription ID of the management subscription."
                    }
                  },
                  "managementResourceGroup": {
                    "type": "string",
                    "metadata": {
                      "description": "Name of the management resource group. The maintenance configuration will be deloyed there."
                    }
                  },
                  "location": {
                    "type": "string",
                    "metadata": {
                      "description": "Location of the maintenance resources."
                    }
                  },
                  "duration": {
                    "defaultValue": "03:55",
                    "type": "String",
                    "metadata": {
                      "description": "Duration of the maintance window in format hh:mm. Maximum value is 03:55."
                    }
                  },
                  "timeZone": {
                    "defaultValue": "W. Europe Standard Time",
                    "type": "String"
                  },
                  "startDate": {
                    "defaultValue": "[utcNow('yyyy-MM-dd')]",
                    "type": "string"
                  },
                  "osTypes": {
                    "type": "array",
                    "metadata": {
                      "description": "OS Types that get filtered for in the cinfiguration assignment."
                    }
                  },
                  "resourceTypes": {
                    "type": "array",
                    "metadata": {
                      "description": "ResourceTypes that get filtered for in the cinfiguration assignment."
                    }
                  }
                },
                "variables": {
                  "updateOptions": {
                    "C": "Critical",
                    "S": "Security",
                    "U": "UpdateRollup",
                    "F": "FeaturePack",
                    "E": "ServicePack",
                    "D": "Definition",
                    "T": "Tools",
                    "G": "Updates"
                  },
                  "rebootOptions": {
                    "reboot": "IfRequired",
                    "alwaysreboot": "Always",
                    "neverreboot": "Never"
                  },
                  "splitSeverityGroup": "[split(parameters('severityGroupName'),'-')]",
                  "recurEvery": "[concat(variables('splitSeverityGroup')[0], 'Month', ' ', variables('splitSeverityGroup')[1],' ', variables('splitSeverityGroup')[2])]",
                  "startTime": "[concat(substring(variables('splitSeverityGroup')[3], 0, 2), ':', substring(variables('splitSeverityGroup')[3], 2, 2)  )]",
                  "startDateTime": "[concat(parameters('startDate'), ' ', variables('startTime'))]",
                  "updateClassification": "[map(range(0, sub(length(replace(variables('splitSeverityGroup')[4],'X', '')), 1 )), lambda('i', variables('updateOptions')[substring(replace(variables('splitSeverityGroup')[4],'X',''), lambdaVariables('i'),1 )] )) ]",
                  "rebootSetting": "[variables('rebootOptions')[variables('splitSeverityGroup')[5]]]",
                  "uniqueDeploymentName": "[concat('NestedDeploymentName-', uniqueString(deployment().name))]"
                },
                "resources": [
                  {
                    "type": "Microsoft.Resources/deployments",
                    "apiVersion": "2019-10-01",
                    "name": "[variables('uniqueDeploymentName')]",
                    "subscriptionId": "[parameters('managementSubscriptionId')]",
                    "resourceGroup": "[parameters('managementResourceGroup')]",
                    "properties": {
                      "mode": "Incremental",
                      "template": {
                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "variables": {},
                        "resources": [
                          {
                            "type": "Microsoft.Maintenance/maintenanceConfigurations",
                            "apiVersion": "2023-04-01",
                            "name": "[parameters('severityGroupName')]",
                            "location": "[parameters('location')]",
                            "properties": {
                              "extensionProperties": {
                                "InGuestPatchMode": "User"
                              },
                              "installPatches": {
                                "rebootSetting": "[variables('rebootSetting')]",
                                "windowsParameters": {
                                  "classificationsToInclude": "[variables('updateClassification')]",
                                  "excludeKbsRequiringReboot": "",
                                  "kbNumbersToExclude": [],
                                  "kbNumbersToInclude": []
                                }
                              },
                              "maintenanceScope": "InGuestPatch",
                              "maintenanceWindow": {
                                "duration": "[parameters('duration')]",
                                "recurEvery": "[variables('recurEvery')]",
                                "startDateTime": "[variables('startDateTime')]",
                                "timeZone": "[parameters('timeZone')]"
                              }
                            }
                          }
                        ]
                      }
                    }
                  },
                  {
                    "type": "Microsoft.Maintenance/configurationAssignments",
                    "apiVersion": "2023-04-01",
                    "name": "[parameters('severityGroupName')]",
                    "dependsOn": [
                      "[concat('Microsoft.Resources/deployments/',variables('uniqueDeploymentName'))]"
                    ],
                    "properties": {
                      "filter": {
                        "resourceTypes": "[parameters('resourceTypes')]",
                        "locations": [],
                        "osTypes": "[parameters('osTypes')]",
                        "resourceGroups": [],
                        "tagSettings": {
                          "filterOperator": "All",
                          "tags": {
                            "Severity Group Monthly": [
                              "[parameters('severityGroupName')]"
                            ],
                            "Update Allowed": [
                              "yes"
                            ]
                          }
                        }
                      },
                      "maintenanceConfigurationId": "[resourceId(subscription().subscriptionId, parameters('managementResourceGroup'), 'microsoft.maintenance/maintenanceconfigurations', parameters('severityGroupName'))]"
                    }
                  }
                ]
              }
            }
          }
        }
      }
    }
  }
}