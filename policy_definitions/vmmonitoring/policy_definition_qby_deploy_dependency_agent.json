{
    "name": "QBY-Deploy-DependencyAgent",
    "type": "Microsoft.Authorization/policyDefinitions",
    "properties": {
       "displayName": "Deploy Dependency Agent",
       "policyType": "Custom",
       "mode": "Indexed",
       "description": "Deploy Dependency agent for Windows and Linux virtual machine scale sets and virtual machines if the agent is not installed.",
       "metadata": {
          "version": "3.1.0",
          "category": "Monitoring"
       },
       "parameters": {},
       "policyRule": {
          "if": {
             "anyOf": [
                {
                   "field": "type",
                   "equals": "Microsoft.Compute/virtualMachineScaleSets"
                },
                {
                   "field": "type",
                   "equals": "Microsoft.Compute/virtualMachines"
                }
             ]
          },
          "then": {
             "effect": "DeployIfNotExists",
             "details": {
                "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
                "roleDefinitionIds": [
                   "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c"
                ],
                "existenceCondition": {
                   "allOf": [
                      {
                         "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/type",
                         "equals": "DependencyAgentWindows"
                      },
                      {
                         "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/publisher",
                         "equals": "Microsoft.Azure.Monitoring.DependencyAgent"
                      }
                   ]
                },
                "deployment": {
                   "properties": {
                      "mode": "incremental",
                      "template": {
                         "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                         "contentVersion": "1.0.0.0",
                         "parameters": {
                            "vmName": {
                               "type": "string"
                            },
                            "location": {
                               "type": "string"
                            },
                            "resourceType": {
                               "type": "string"
                            },
                            "platform": {
                               "type": "string"
                            }
                         },
                         "variables": {
                            "vmExtensionName": "[concat('DependencyAgent', parameters('platform'))]",
                            "vmExtensionPublisher": "Microsoft.Azure.Monitoring.DependencyAgent",
                            "vmExtensionType": "[concat('DependencyAgent', parameters('platform'))]",
                            "vmExtensionTypeHandlerVersion": "9.10"
                         },
                         "resources": [
                            {
                               "type": "[concat(parameters('resourceType'), '/extensions']",
                               "name": "[concat(parameters('vmName'), '/', variables('vmExtensionName'))]",
                               "apiVersion": "2021-04-01",
                               "location": "[parameters('location')]",
                               "properties": {
                                  "publisher": "[variables('vmExtensionPublisher')]",
                                  "type": "[variables('vmExtensionType')]",
                                  "typeHandlerVersion": "[variables('vmExtensionTypeHandlerVersion')]",
                                  "autoUpgradeMinorVersion": true
                               }
                            }
                         ],
                         "outputs": {
                            "policy": {
                               "type": "string",
                               "value": "[concat('Enabled extension for: ', parameters('vmName'))]"
                            }
                         }
                      },
                      "parameters": {
                         "vmName": {
                            "value": "[field('name')]"
                         },
                         "location": {
                            "value": "[field('location')]"
                         },
                         "resourceType": {
                            "value": "[field('type')]"
                         },
                         "platform": {
                            "value": "[field(concat(field('type'), '/storageProfile.osDisk.osType'))]"
                         }
                      }
                   }
                }
             }
          }
       }
    }
 }